<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìƒì¶”&ê¹€ì¹˜ í¼ì¦ (Red Edition)</title>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            width: 100vw; height: 100vh;
            background-color: #FFC0CB;
            font-family: 'Jua', sans-serif;
            overflow: hidden;
            display: flex; flex-direction: column; align-items: center;
        }

        /* === ìƒë‹¨ ì˜ì—­ === */
        #top-area {
            height: 20%; width: 100%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            background: rgba(255,255,255,0.4);
            z-index: 10;
        }
        #ref-title { color: #d63384; font-size: 1.2rem; margin-bottom: 5px; }
        #ref-img { 
            height: 70%; width: auto; 
            border: 3px solid #fff; border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* === ì¤‘ì•™ ê²Œì„ ì˜ì—­ === */
        #game-area {
            height: 60%; width: 100%;
            display: flex; justify-content: center; align-items: center;
            position: relative;
        }

        #puzzle-board {
            width: 90vw; height: 90vw;
            max-width: 50vh; max-height: 50vh;
            
            /* [ì‹œì‘ í™”ë©´] ë°°ê²½ì— í¬ë¯¸í•œ ê·¸ë¦¼ í‘œì‹œ */
            background-image: linear-gradient(rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.7)), url('kimchi-b.png');
            background-size: 100% 100%;
            background-position: center;
            transition: background 0.5s; /* ë¶€ë“œëŸ½ê²Œ ì „í™˜ */

            border: 4px solid #333;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 0;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        /* [ê²Œì„ í”Œë ˆì´ ì¤‘] ë°°ê²½ ê·¸ë¦¼ ì œê±° (í°ìƒ‰) */
        #puzzle-board.playing {
            background-image: none;
            background-color: #fff;
        }

        .tile {
            width: 100%; height: 100%;
            background-size: 400% 400%;
            cursor: pointer;
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* [ì¤‘ìš”] ë¹ˆ ì¹¸ ìŠ¤íƒ€ì¼ (ê²Œì„ ì¤‘) */
        .empty-tile {
            /* ë¹¨ê°„ìƒ‰ìœ¼ë¡œ í‘œì‹œ! (íˆ¬ëª…ë„ ì¡°ì ˆë¡œ ëˆˆ ì•ˆ ì•„í”„ê²Œ) */
            background-image: none !important;
            background-color: rgba(255, 0, 0, 0.6) !important; 
            border: 2px solid #ff0000 !important;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
        }

        /* === í•˜ë‹¨ ì˜ì—­ === */
        #bottom-area {
            height: 20%; width: 100%;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px;
            background: linear-gradient(to top, rgba(255,255,255,0.6), transparent);
        }
        .deco-cat {
            height: 80%; width: auto; object-fit: contain;
            filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.2));
            animation: bounce 2s infinite ease-in-out;
        }
        #cat-right { animation-delay: 1s; }

        #btn-start {
            padding: 12px 24px; font-size: 1.2rem;
            font-family: 'Jua', sans-serif;
            background-color: #fff; color: #333;
            border: 3px solid #333; border-radius: 30px;
            box-shadow: 0 4px 0 #333; cursor: pointer; z-index: 20;
        }
        #btn-start:active { transform: translateY(3px); box-shadow: 0 1px 0 #333; }

        /* === ì˜¤ë²„ë ˆì´ === */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 100; color: white;
        }
        #overlay-msg { font-size: 2rem; margin-bottom: 20px; }
        #success-img { width: 60%; border: 5px solid #fff; border-radius: 15px; }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
    </style>
</head>
<body>
    <div id="top-area">
        <div id="ref-title">â­ ì™„ì„± ì˜ˆì‹œ â­</div>
        <img src="kimchi-b.png" id="ref-img" alt="ì •ë‹µ ê·¸ë¦¼">
    </div>

    <div id="game-area">
        <div id="puzzle-board"></div>
        <div id="overlay">
            <div id="overlay-msg">ì¤€ë¹„...</div>
            <img src="kimchi-L.png" id="success-img">
        </div>
    </div>

    <div id="bottom-area">
        <img src="kimchi-o2.webp" id="cat-left" class="deco-cat">
        <button id="btn-start" onclick="initGame()">GAME START</button>
        <img src="kimchi-o3.webp" id="cat-right" class="deco-cat">
    </div>

    <script>
        const ROWS = 4;
        const COLS = 4;
        const IMG_MAIN = 'kimchi-b.png';
        const IMG_SUCCESS = 'kimchi-L.png';
        
        let tiles = [];
        let emptyIndex = 15;
        let isPlaying = false;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'slide') {
                osc.frequency.setValueAtTime(600, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'win') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(523, now); osc.frequency.setValueAtTime(659, now + 0.2); osc.frequency.setValueAtTime(783, now + 0.4);
                gainNode.gain.linearRampToValueAtTime(0, now + 1.5);
                osc.start(now); osc.stop(now + 1.5);
            } else if (type === 'start') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(400, now);
                gainNode.gain.linearRampToValueAtTime(0, now + 0.2);
                osc.start(now); osc.stop(now + 0.2);
            }
        }

        function initGame() {
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const board = document.getElementById('puzzle-board');
            const overlay = document.getElementById('overlay');
            const overlayMsg = document.getElementById('overlay-msg');
            const successImg = document.getElementById('success-img');

            tiles = [];
            isPlaying = false;
            successImg.style.display = 'none';
            board.innerHTML = '';
            
            // ì‹œì‘ í™”ë©´: ë°°ê²½ ê·¸ë¦¼ ë³´ì´ê²Œ (playing í´ë˜ìŠ¤ ì œê±°)
            board.classList.remove('playing');

            // íƒ€ì¼ ìƒì„± (ì •ë‹µ ìƒíƒœ, ë¹ˆì¹¸ ì—†ìŒ)
            for (let i = 0; i < ROWS * COLS; i++) {
                tiles.push(i);
                // ì„¸ ë²ˆì§¸ ì¸ì false: ë¹ˆì¹¸ ì—†ì´ ê½‰ ì±„ìš´ ê·¸ë¦¼ ìƒì„±
                createTileElement(i, i, false);
            }

            overlay.style.display = 'flex';
            let count = 3;
            overlayMsg.innerText = "ì¤€ë¹„...";
            playSound('start');

            const countdown = setInterval(() => {
                overlayMsg.innerText = count + "!";
                playSound('start');
                count--;
                if (count < 0) {
                    clearInterval(countdown);
                    overlayMsg.innerText = "Start!";
                    setTimeout(() => {
                        overlay.style.display = 'none';
                        // ê²Œì„ ì‹œì‘: ë°°ê²½ ì œê±° ë° ì„ê¸°
                        board.classList.add('playing');
                        shuffleTiles();
                        isPlaying = true;
                    }, 500);
                }
            }, 800);
        }

        function createTileElement(posIndex, imgIndex, showEmpty = true) {
            const board = document.getElementById('puzzle-board');
            const tile = document.createElement('div');
            
            tile.classList.add('tile');
            tile.id = `tile-${posIndex}`;
            
            // showEmptyê°€ trueì´ê³  ë§ˆì§€ë§‰ íƒ€ì¼ì´ë©´ 'ë¹ˆì¹¸' ì²˜ë¦¬
            if (showEmpty && imgIndex === ROWS * COLS - 1) {
                tile.classList.add('empty-tile');
            } else {
                const xPercent = (imgIndex % COLS) * (100 / (COLS - 1));
                const yPercent = Math.floor(imgIndex / ROWS) * (100 / (ROWS - 1));
                tile.style.backgroundImage = `url('${IMG_MAIN}')`;
                tile.style.backgroundPosition = `${xPercent}% ${yPercent}%`;
            }
            
            tile.onclick = () => moveTile(posIndex);
            board.appendChild(tile);
        }

        function shuffleTiles() {
            tiles = Array.from({length: 16}, (_, i) => i);
            emptyIndex = 15;
            let count = 0;
            const maxMoves = 200; 
            
            // ì„ì„ ë•Œë¶€í„° ë¹ˆì¹¸ì„ í‘œì‹œí•´ì•¼ í•˜ë¯€ë¡œ ë‹¤ì‹œ ê·¸ë¦¼
            renderBoard();

            const interval = setInterval(() => {
                const neighbors = getNeighbors(emptyIndex);
                const randomNeighbor = neighbors[Math.floor(Math.random() * neighbors.length)];
                [tiles[emptyIndex], tiles[randomNeighbor]] = [tiles[randomNeighbor], tiles[emptyIndex]];
                emptyIndex = randomNeighbor;
                renderBoard();
                count++;
                if (count >= maxMoves) clearInterval(interval);
            }, 5);
        }

        function getNeighbors(idx) {
            const neighbors = [];
            const row = Math.floor(idx / COLS);
            const col = idx % COLS;
            if (row > 0) neighbors.push(idx - COLS);
            if (row < ROWS - 1) neighbors.push(idx + COLS);
            if (col > 0) neighbors.push(idx - 1);
            if (col < COLS - 1) neighbors.push(idx + 1);
            return neighbors;
        }

        function moveTile(clickIndex) {
            if (!isPlaying) return;
            const neighbors = getNeighbors(emptyIndex);
            if (neighbors.includes(clickIndex)) {
                [tiles[emptyIndex], tiles[clickIndex]] = [tiles[clickIndex], tiles[emptyIndex]];
                emptyIndex = clickIndex;
                playSound('slide');
                renderBoard();
                checkWin();
            }
        }

        function renderBoard() {
            const board = document.getElementById('puzzle-board');
            board.innerHTML = '';
            tiles.forEach((imgNum, posIndex) => {
                // ê²Œì„ ì¤‘ì—ëŠ” ë¹ˆì¹¸(showEmpty=true)ì„ í¬í•¨í•´ì„œ ìƒì„±
                createTileElement(posIndex, imgNum, true);
            });
        }

        function checkWin() {
            const isWin = tiles.every((val, index) => val === index);
            if (isWin && isPlaying) {
                isPlaying = false;
                playSound('win');
                setTimeout(() => {
                    const overlay = document.getElementById('overlay');
                    const overlayMsg = document.getElementById('overlay-msg');
                    const successImg = document.getElementById('success-img');
                    
                    // ì„±ê³µ ì‹œ ë¹ˆì¹¸ ì±„ìš°ê¸°
                    const lastTile = document.querySelector('.empty-tile');
                    if(lastTile) {
                        lastTile.classList.remove('empty-tile');
                        lastTile.style.backgroundImage = `url('${IMG_MAIN}')`;
                        lastTile.style.backgroundPosition = `100% 100%`;
                        lastTile.style.backgroundColor = 'transparent'; // ë¹¨ê°„ìƒ‰ ì œê±°
                        lastTile.style.border = '1px solid rgba(0,0,0,0.1)';
                    }
                    // ì„±ê³µ ì‹œ ë°°ê²½ ë‹¤ì‹œ ë³´ì´ê¸°
                    document.getElementById('puzzle-board').classList.remove('playing');

                    overlay.style.display = 'flex';
                    overlayMsg.innerText = "ğŸ‰ ì„±ê³µ! ì¶•í•˜í•´ìš”! ğŸ‰";
                    successImg.src = IMG_SUCCESS;
                    successImg.style.display = 'block';
                }, 300);
            }
        }
    </script>
</body>
</html>